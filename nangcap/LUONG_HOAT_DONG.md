# ğŸš— LUá»’NG HOáº T Äá»˜NG Há»† THá»NG BÃƒI Äá»– XE

## ğŸ“‹ Tá»•ng quan há»‡ thá»‘ng

### **Thiáº¿t bá»‹:**
1. **ESP32 BAIDOXE (gate01)** - Cá»•ng vÃ o/ra bÃ£i
   - 2 RFID: RFID-A (IN) vÃ  RFID-B (OUT)
   - Gá»­i MQTT topics: `parking/gate/gate01/in`, `parking/gate/gate01/out`

2. **ESP32 THANHTOAN (gate02)** - MÃ¡y thanh toÃ¡n
   - 1 RFID + TFT mÃ n hÃ¬nh
   - Gá»­i MQTT topics: `parking/payment/gate02/card_scanned`, `parking/payment/gate02/payment_confirmed`

3. **Python App** - Server xá»­ lÃ½ ALPR vÃ  quáº£n lÃ½
   - Nháº­n dáº¡ng biá»ƒn sá»‘ (YOLOv8 + EasyOCR)
   - Quáº£n lÃ½ in_records.json
   - Tracking revenue realtime

---

## ğŸ¯ LUá»’NG HOáº T Äá»˜NG CHI TIáº¾T

### **1. XE VÃ€O BÃƒI (IN)** ğŸš™â¡ï¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Quáº¹t tháº» â”‚ KhÃ¡ch quáº¹t tháº» RFID táº¡i RFID-A (cá»•ng vÃ o)
â”‚   RFID-A    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ESP32 gá»­i MQTT                   â”‚
â”‚    Topic: parking/gate/gate01/in    â”‚
â”‚    Payload: {"card_id": "33-00-61-F5"}
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Python App nháº­n signal           â”‚
â”‚    - Trigger camera IN              â”‚
â”‚    - Chá»¥p áº£nh xe                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ALPR nháº­n dáº¡ng biá»ƒn sá»‘           â”‚
â”‚    - YOLOv8 detect vÃ¹ng biá»ƒn        â”‚
â”‚    - EasyOCR Ä‘á»c kÃ½ tá»±              â”‚
â”‚    - Multi-frame voting             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. LÆ°u vÃ o in_records               â”‚
â”‚    {                                â”‚
â”‚      "33-00-61-F5": {               â”‚
â”‚        "plate": "365-D 7769",       â”‚
â”‚        "time": "2025-10-17T15:03:10"â”‚
â”‚        "card_id": "33-00-61-F5",    â”‚
â”‚        "paid": false                â”‚
â”‚      }                              â”‚
â”‚    }                                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Update counters & UI             â”‚
â”‚    - Daily counter +1               â”‚
â”‚    - Used slots +1                  â”‚
â”‚    - Save to in_records.json        â”‚
â”‚    - Update UI                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Káº¿t quáº£:**
- âœ… Xe Ä‘Æ°á»£c ghi nháº­n vÃ o bÃ£i
- âœ… Tháº» RFID Ä‘Æ°á»£c liÃªn káº¿t vá»›i biá»ƒn sá»‘
- âœ… Slot count Ä‘Æ°á»£c cáº­p nháº­t

---

### **2. THANH TOÃN Táº I TERMINAL** ğŸ’³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Quáº¹t tháº» â”‚ KhÃ¡ch quáº¹t tháº» táº¡i payment terminal
â”‚  Terminal   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ESP32 gá»­i MQTT                        â”‚
â”‚    Topic: parking/payment/gate02/card_scanned
â”‚    Payload: {"card_id": "33-00-61-F5"}   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Python App tÃ¬m tháº» trong in_records   â”‚
â”‚    - Check card_id cÃ³ trong records khÃ´ngâ”‚
â”‚    - Láº¥y thÃ´ng tin: plate, time_in, fee  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. App gá»­i thÃ´ng tin xe vá» Terminal      â”‚
â”‚    Topic: parking/payment/gate02/vehicle_info
â”‚    Payload (chÆ°a thanh toÃ¡n): {          â”‚
â”‚      "plate": "365-D 7769",              â”‚
â”‚      "time_in": "15:03:10",              â”‚
â”‚      "time_out": "16:30:00",             â”‚
â”‚      "fee": 3000,                        â”‚
â”‚      "paid": false                       â”‚
â”‚    }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Terminal hiá»ƒn thá»‹ thÃ´ng tin           â”‚
â”‚    - Biá»ƒn sá»‘: 365-D 7769                 â”‚
â”‚    - Sá»‘ tiá»n: 3000 VND                   â”‚
â”‚    - Countdown 10 giÃ¢y                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Auto thanh toÃ¡n sau 10s               â”‚
â”‚    - Hiá»ƒn thá»‹ animation success          â”‚
â”‚    - Gá»­i xÃ¡c nháº­n vá» app                 â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ESP32 gá»­i payment_confirmed           â”‚
â”‚    Topic: parking/payment/gate02/payment_confirmed
â”‚    Payload: {"card_id": "33-00-61-F5"}   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Python App xá»­ lÃ½ thanh toÃ¡n           â”‚
â”‚    - Mark record: paid = true            â”‚
â”‚    - Revenue += 3000                     â”‚
â”‚    - GIá»® trong in_records (chÆ°a xÃ³a!)    â”‚
â”‚    - Update UI realtime                  â”‚
â”‚    - Save to in_records.json             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Káº¿t quáº£:**
- âœ… Revenue Ä‘Æ°á»£c cáº­p nháº­t ngay
- âœ… Tháº» Ä‘Æ°á»£c Ä‘Ã¡nh dáº¥u Ä‘Ã£ thanh toÃ¡n (`paid = true`)
- âš ï¸ Xe VáºªN á»Ÿ trong bÃ£i (chÆ°a ra)
- âš ï¸ Record VáºªN trong in_records (Ä‘á»ƒ xe ra sau)

---

### **2B. QUáº¸T Láº I THáºº ÄÃƒ THANH TOÃN** ğŸŸ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Quáº¹t láº¡i â”‚ KhÃ¡ch quáº¹t láº¡i tháº» Ä‘Ã£ thanh toÃ¡n
â”‚  Terminal   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ESP32 gá»­i card_scanned                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. App check: paid = true                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. App gá»­i thÃ´ng tin ÄÃƒ THANH TOÃN       â”‚
â”‚    Payload: {                            â”‚
â”‚      "plate": "365-D 7769",              â”‚
â”‚      "fee": 0,          â¬…ï¸ ÄÃ£ thanh toÃ¡n â”‚
â”‚      "paid": true       â¬…ï¸ Quan trá»ng!   â”‚
â”‚    }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Terminal hiá»ƒn thá»‹ MÃ€N HÃŒNH CAM ğŸŸ      â”‚
â”‚    - Icon checkmark trong vÃ²ng cam       â”‚
â”‚    - Text: "ÄÃƒ THANH TOÃN Rá»’I!"         â”‚
â”‚    - Biá»ƒn sá»‘: 365-D 7769                 â”‚
â”‚    - Sá»‘ tiá»n: 0 VND                      â”‚
â”‚    - Tá»± Ä‘á»™ng Ä‘Ã³ng sau 3 giÃ¢y             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Káº¿t quáº£:**
- âœ… KhÃ´ng cho thanh toÃ¡n láº¡i
- âœ… Hiá»ƒn thá»‹ mÃ n hÃ¬nh cam
- âœ… Revenue khÃ´ng tÄƒng thÃªm

---

### **3. XE RA KHá»I BÃƒI (OUT)** ğŸš™â¬…ï¸

#### **3A. TrÆ°á»ng há»£p ÄÃƒ THANH TOÃN táº¡i Terminal**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Quáº¹t tháº» â”‚ KhÃ¡ch quáº¹t tháº» táº¡i RFID-B (cá»•ng ra)
â”‚   RFID-B    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ESP32 gá»­i MQTT                   â”‚
â”‚    Topic: parking/gate/gate01/out   â”‚
â”‚    Payload: {"card_id": "33-00-61-F5"}
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Python App nháº­n signal           â”‚
â”‚    - Trigger camera OUT             â”‚
â”‚    - Chá»¥p áº£nh xe                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ALPR nháº­n dáº¡ng biá»ƒn sá»‘           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. TÃ¬m record trong in_records      â”‚
â”‚    - Check: paid = true             â”‚
â”‚    - Xe Ä‘Ã£ thanh toÃ¡n rá»“i!          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Xá»­ lÃ½ xe ra                      â”‚
â”‚    - TÃ­nh thá»i gian gá»­i xe          â”‚
â”‚    - Fee = 0 (Ä‘Ã£ tráº£ rá»“i)           â”‚
â”‚    - KHÃ”NG cá»™ng revenue             â”‚
â”‚    - XÃ“A khá»i in_records            â”‚
â”‚    - Used slots -1                  â”‚
â”‚    - Update UI: "ÄÃ£ thanh toÃ¡n"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Káº¿t quáº£:**
- âœ… Xe Ä‘Æ°á»£c phÃ©p ra
- âœ… KhÃ´ng thu phÃ­ (Ä‘Ã£ tráº£ táº¡i terminal)
- âœ… Slot Ä‘Æ°á»£c giáº£i phÃ³ng
- âœ… Revenue khÃ´ng Ä‘á»•i (Ä‘Ã£ tÃ­nh lÃºc thanh toÃ¡n)

---

#### **3B. TrÆ°á»ng há»£p CHÆ¯A THANH TOÃN**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Quáº¹t tháº» â”‚ KhÃ¡ch quáº¹t tháº» táº¡i RFID-B (cá»•ng ra)
â”‚   RFID-B    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2-4. Giá»‘ng flow Ä‘Ã£ thanh toÃ¡n       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. TÃ¬m record trong in_records      â”‚
â”‚    - Check: paid = false            â”‚
â”‚    - Xe CHÆ¯A thanh toÃ¡n!            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Xá»­ lÃ½ thanh toÃ¡n táº¡i cá»•ng        â”‚
â”‚    - TÃ­nh thá»i gian gá»­i xe          â”‚
â”‚    - Fee = 3000 VND                 â”‚
â”‚    - Revenue += 3000                â”‚
â”‚    - XÃ“A khá»i in_records            â”‚
â”‚    - Used slots -1                  â”‚
â”‚    - Update UI                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Káº¿t quáº£:**
- âœ… Xe Ä‘Æ°á»£c phÃ©p ra
- âœ… Thu phÃ­ táº¡i cá»•ng
- âœ… Slot Ä‘Æ°á»£c giáº£i phÃ³ng
- âœ… Revenue Ä‘Æ°á»£c cáº­p nháº­t

---

## ğŸ“Š in_records.json Structure

```json
{
  "summary": {
    "total_revenue": 24000,
    "daily_in_count": 8,
    "last_date": "2025-10-18"
  },
  "vehicles": {
    "33-00-61-F5": {
      "plate": "365-D 7769",
      "time": "2025-10-18T15:03:10",
      "card_id": "33-00-61-F5",
      "paid": true
    },
    "AA-BB-CC-DD": {
      "plate": "29-A1 12345",
      "time": "2025-10-18T16:20:00",
      "card_id": "AA-BB-CC-DD",
      "paid": false
    }
  }
}
```

**Field `paid`:**
- `false` - ChÆ°a thanh toÃ¡n â†’ Thu phÃ­ khi ra
- `true` - ÄÃ£ thanh toÃ¡n táº¡i terminal â†’ KhÃ´ng thu phÃ­ khi ra

---

## ğŸ”„ MQTT Topics Summary

### **ESP32 BAIDOXE â†’ App**
| Topic | Payload | MÃ´ táº£ |
|-------|---------|-------|
| `parking/gate/gate01/in` | `{"card_id": "..."}` | Xe vÃ o (quáº¹t RFID-A) |
| `parking/gate/gate01/out` | `{"card_id": "..."}` | Xe ra (quáº¹t RFID-B) |
| `parking/gate/gate01/heartbeat` | `{"mac": "...", "ip": "..."}` | Heartbeat |
| `parking/gate/gate01/status` | `{"online": true}` | Status |

### **ESP32 THANHTOAN â†”ï¸ App**
| Direction | Topic | Payload | MÃ´ táº£ |
|-----------|-------|---------|-------|
| ESP32 â†’ App | `parking/payment/gate02/card_scanned` | `{"card_id": "..."}` | Quáº¹t tháº» táº¡i terminal |
| **App â†’ ESP32** | `parking/payment/gate02/vehicle_info` | `{"plate": "...", "fee": 3000, "paid": false}` | Gá»­i info xe vá» terminal |
| ESP32 â†’ App | `parking/payment/gate02/payment_confirmed` | `{"card_id": "..."}` | XÃ¡c nháº­n Ä‘Ã£ thanh toÃ¡n |
| ESP32 â†’ App | `parking/payment/gate02/heartbeat` | `{"mac": "...", "ip": "..."}` | Heartbeat |

---

## ğŸ“‹ Báº£ng tÃ³m táº¯t Payment Terminal Logic

| TrÆ°á»ng há»£p | `paid` | `fee` | Terminal hiá»ƒn thá»‹ | Revenue thay Ä‘á»•i | Ghi chÃº |
|------------|--------|-------|-------------------|------------------|---------|
| **Láº§n Ä‘áº§u quáº¹t** (chÆ°a tráº£) | `false` | `3000` | âšª Xanh lÃ¡: "Sá» TIá»€N: 3000 VND" + countdown | +3000 | Cho phÃ©p thanh toÃ¡n |
| **Quáº¹t láº¡i** (Ä‘Ã£ tráº£) | `true` | `0` | ğŸŸ  Cam: "ÄÃƒ THANH TOÃN Rá»’I!" | KhÃ´ng Ä‘á»•i | KhÃ´ng cho thanh toÃ¡n láº¡i |
| **Xe ra** (Ä‘Ã£ tráº£ táº¡i terminal) | `true` | `0` | N/A (cá»•ng ra) | KhÃ´ng Ä‘á»•i | Hiá»ƒn thá»‹ "ÄÃ£ thanh toÃ¡n" |
| **Xe ra** (chÆ°a tráº£) | `false` | `3000` | N/A (cá»•ng ra) | +3000 | Thu phÃ­ táº¡i cá»•ng |

### **Logic ESP32 thanhtoan:**
```cpp
// DÃ²ng 696-708 trong main.cpp
if (currentVehicle.isPaid && currentVehicle.fee == 0) {
    // âœ… Cáº¢ HAI Ä‘iá»u kiá»‡n pháº£i Ä‘Ãºng:
    // 1. paid = true
    // 2. fee = 0
    displayAlreadyPaid();  // Hiá»ƒn thá»‹ mÃ n hÃ¬nh CAM
} else {
    // Hiá»ƒn thá»‹ mÃ n hÃ¬nh thanh toÃ¡n bÃ¬nh thÆ°á»ng
    displayVehicleInfo();
}
```

---

## âš ï¸ LÆ¯U Ã QUAN TRá»ŒNG

### **1. Payment Terminal KHÃ”NG PHáº¢I cá»•ng ra**
- âŒ Terminal khÃ´ng xÃ³a xe khá»i in_records
- âœ… Terminal chá»‰ Ä‘Ã¡nh dáº¥u `paid = true`
- âœ… Xe váº«n trong bÃ£i, chá» quáº¹t RFID-B Ä‘á»ƒ ra

### **2. Revenue chá»‰ tÃ­nh 1 láº§n**
- Náº¿u thanh toÃ¡n táº¡i terminal â†’ Revenue tÄƒng ngay
- Khi ra, check `paid = true` â†’ KhÃ´ng tÃ­nh láº¡i revenue
- Náº¿u khÃ´ng thanh toÃ¡n â†’ Thu phÃ­ táº¡i cá»•ng ra

### **3. Slot count**
- Slot chá»‰ giáº£i phÃ³ng khi quáº¹t RFID-B (cá»•ng ra)
- Thanh toÃ¡n táº¡i terminal KHÃ”NG giáº£m slot

---

## ğŸ¯ Quy trÃ¬nh Ä‘áº§y Ä‘á»§

**KhÃ¡ch hÃ ng Gá»¬I XE:**
1. Quáº¹t tháº» táº¡i RFID-A (vÃ o) â†’ Chá»¥p áº£nh â†’ LÆ°u biá»ƒn sá»‘
2. Xe Ä‘á»— trong bÃ£i

**KhÃ¡ch hÃ ng THANH TOÃN (TÃ¹y chá»n):**
3a. Quáº¹t tháº» táº¡i Payment Terminal â†’ Hiá»ƒn thá»‹ thÃ´ng tin â†’ Auto thanh toÃ¡n â†’ Revenue tÄƒng
3b. Hoáº·c khÃ´ng thanh toÃ¡n, tráº£ tiá»n khi ra

**KhÃ¡ch hÃ ng Láº¤Y XE:**
4. Quáº¹t tháº» táº¡i RFID-B (ra) â†’ Chá»¥p áº£nh
5. Náº¿u Ä‘Ã£ thanh toÃ¡n â†’ Cho ra, khÃ´ng thu phÃ­
6. Náº¿u chÆ°a thanh toÃ¡n â†’ Thu phÃ­, tÄƒng revenue

---

**âœ… Há»‡ thá»‘ng hoÃ n chá»‰nh!**

_Generated: 2025-10-18_
